import"./chunk-3RMIGUHL.js";import"./chunk-CRMNYVNJ.js";import"./chunk-DWTMSAJF.js";import"./chunk-EIUGSWZD.js";import"./chunk-TW6IKH4B.js";import"./chunk-ZWHDOK3R.js";import"./chunk-4PGTP63H.js";import"./chunk-BDVXA75T.js";import"./chunk-HC6MZPB3.js";import"./chunk-I3LG7LOT.js";import"./chunk-FERD25SW.js";import"./chunk-7EU7YSXT.js";import"./chunk-LEIMCQKJ.js";import"./chunk-KKMBB4JE.js";import"./chunk-BZ2JL7UE.js";import"./chunk-5OMUW5VI.js";import"./chunk-OBXDPQ3V.js";import"./chunk-GZWEEWZ4.js";import"./chunk-MCRJI3T3.js";import"./chunk-MAJNWM2K.js";import"./chunk-5LUBTVRJ.js";import{a as v}from"./chunk-GGPG3CNO.js";import{B as m,Ba as F,Cb as J,D as o,E as a,F as y,Fb as $,Ga as K,Gb as z,Ha as A,Hb as U,J as M,K as p,L as f,Nb as Y,Ob as q,S as c,T as b,U as C,W as S,X as I,Y as x,ab as Q,fa as E,ga as R,hb as O,ib as V,j as g,ja as k,k as h,pb as B,r as l,s as T,sa as G,tb as X,u as w,ub as W,vb as D,wb as j,xb as L,y as P,ya as N}from"./chunk-GOUZPZED.js";import"./chunk-L2GIMNSN.js";import"./chunk-7KGURMOZ.js";import"./chunk-YZINE4VV.js";import"./chunk-OITPVWB3.js";import"./chunk-YXCBSPVC.js";import"./chunk-HII7ZFLR.js";import"./chunk-7JVEMCNU.js";import"./chunk-Z65EUC5N.js";import"./chunk-4U6PRYVA.js";import"./chunk-ETCIABSX.js";import"./chunk-JWIEPCRG.js";import"./chunk-QPVVTFFW.js";import"./chunk-J6ICYO4L.js";import"./chunk-LF5XB4YN.js";import{f as H}from"./chunk-RW4GY4BD.js";function re(d,s){if(d&1){let r=M();o(0,"ion-item",8),p("click",function(){let t=g(r).$implicit,e=f();return h(e.seleccionarProducto(t))}),o(1,"ion-label")(2,"h2"),c(3),a(),o(4,"p"),c(5),a(),o(6,"p"),c(7),a()()()}if(d&2){let r=s.$implicit;m("button",!0),l(3),b(r.nombre),l(2),b(r.descripcion),l(2),C("Precio neto : ",r.precioNeto," \u20AC")}}function ae(d,s){if(d&1&&(o(0,"ion-select-option",9),c(1),a()),d&2){let r=s.$implicit;m("value",r),l(),b(r)}}var ne=(()=>{let s=class s{constructor(i){this.modalController=i,this.productos=[],this.searchTerm="",this.currentPage=1,this.totalPages=1,this.pageSize=20,this.pageOptions=[]}ngOnInit(){this.loadProductos()}loadProductos(i=1){let t=localStorage.getItem("accessToken");if(!t){console.log("No se encontr\xF3 el token de acceso");return}let e="";i===1?e=v.apiUrl+`/producto/activos/page/${this.currentPage}`:i===2&&(e=v.apiUrl+`/producto/buscar/activos/${this.searchTerm}/page/${this.currentPage}`),fetch(e,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`}}).then(n=>{if(!n.ok)throw new Error("Error en la solicitud");return n.json()}).then(n=>{console.log("Respuesta completa:",n),typeof n=="string"&&(n=JSON.parse(n),console.log("Convertido a JSON:",n)),Array.isArray(n)?this.productos=n:n&&n.content?(this.productos=n.content,this.totalPages=n.totalPages||1,this.pageOptions=Array.from({length:this.totalPages},(u,_)=>_+1)):console.warn("Formato de datos inesperado:",n)})}onSearchInput(){this.searchTerm.trim()===""?this.loadProductos(1):this.loadProductos(2)}seleccionarProducto(i){this.modalController.dismiss({producto:i})}cancelar(){this.modalController.dismiss()}changePage(i){i==="prev"&&this.currentPage>1?this.currentPage--:i==="next"&&this.currentPage<this.totalPages&&this.currentPage++,this.loadProductos()}previousPage(){this.currentPage>1&&(this.currentPage--,this.loadProductos())}nextPage(){this.currentPage<this.totalPages&&(this.currentPage++,this.loadProductos())}};s.\u0275fac=function(t){return new(t||s)(T(U))},s.\u0275cmp=w({type:s,selectors:[["app-producto-search-modal"]],decls:18,vars:7,consts:[["slot","end"],[3,"click"],[3,"ngModelChange","ionInput","ngModel","debounce"],[3,"button","click",4,"ngFor","ngForOf"],[2,"display","flex","justify-content","center","align-items","center","margin-top","20px","margin-bottom","20px"],[3,"click","disabled"],["interface","popover",3,"ngModelChange","ionChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[3,"click","button"],[3,"value"]],template:function(t,e){t&1&&(o(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),c(3,"Buscar Producto"),a(),o(4,"ion-buttons",0)(5,"ion-button",1),p("click",function(){return e.cancelar()}),c(6,"Cerrar"),a()()()(),o(7,"ion-content")(8,"ion-searchbar",2),x("ngModelChange",function(u){return I(e.searchTerm,u)||(e.searchTerm=u),u}),p("ionInput",function(){return e.onSearchInput()}),a(),o(9,"ion-list"),P(10,re,8,4,"ion-item",3),a(),o(11,"div",4)(12,"ion-button",5),p("click",function(){return e.changePage("prev")}),c(13,"\u2190"),a(),o(14,"ion-select",6),x("ngModelChange",function(u){return I(e.currentPage,u)||(e.currentPage=u),u}),p("ionChange",function(){return e.loadProductos()}),P(15,ae,2,2,"ion-select-option",7),a(),o(16,"ion-button",5),p("click",function(){return e.changePage("next")}),c(17,"\u2192"),a()()()),t&2&&(l(8),S("ngModel",e.searchTerm),m("debounce",1e3),l(2),m("ngForOf",e.productos),l(2),m("disabled",e.currentPage===1),l(2),S("ngModel",e.currentPage),l(),m("ngForOf",e.pageOptions),l(),m("disabled",e.currentPage===e.totalPages))},dependencies:[q,L,D,j,O,W,z,V,$,B,A,N,F,J,k,E],styles:['@charset "UTF-8";ion-select[_ngcontent-%COMP%]{max-width:120px;min-width:80px;width:auto;text-align:center}']});let d=s;return d})();function le(d,s){if(d&1){let r=M();o(0,"ion-item",8),p("click",function(){let t=g(r).$implicit,e=f();return h(e.seleccionarCliente(t))}),o(1,"ion-label")(2,"h2"),c(3),a(),o(4,"p"),c(5),a(),o(6,"p"),c(7),a()()()}if(d&2){let r=s.$implicit;m("button",!0),l(3),b(r.nombre),l(2),b(r.nif),l(2),C("Correo : ",r.email,"")}}function ce(d,s){if(d&1&&(o(0,"ion-select-option",9),c(1),a()),d&2){let r=s.$implicit;m("value",r),l(),b(r)}}var oe=(()=>{let s=class s{constructor(i){this.modalController=i,this.clientes=[],this.searchTerm="",this.currentPage=1,this.totalPages=1,this.pageSize=20,this.pageOptions=[]}ngOnInit(){this.loadClientes()}loadClientes(i=1){let t=localStorage.getItem("accessToken");if(!t){console.log("No se encontr\xF3 el token de acceso");return}let e="";i===1?e=v.apiUrl+`/cliente/activos/page/${this.currentPage}`:i===2&&(e=v.apiUrl+`/cliente/buscar/activos/${this.searchTerm}/page/${this.currentPage}`),fetch(e,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`}}).then(n=>{if(!n.ok)throw new Error("Error en la solicitud");return n.json()}).then(n=>{console.log("Respuesta completa:",n),typeof n=="string"&&(n=JSON.parse(n),console.log("Convertido a JSON:",n)),Array.isArray(n)?this.clientes=n:n&&n.content?(this.clientes=n.content,this.totalPages=n.totalPages||1,this.pageOptions=Array.from({length:this.totalPages},(u,_)=>_+1)):console.warn("Formato de datos inesperado:",n)})}onSearchInput(){this.searchTerm.trim()===""?this.loadClientes(1):this.loadClientes(2)}seleccionarCliente(i){this.modalController.dismiss({cliente:i})}cancelar(){this.modalController.dismiss()}changePage(i){i==="prev"&&this.currentPage>1?this.currentPage--:i==="next"&&this.currentPage<this.totalPages&&this.currentPage++,this.loadClientes()}previousPage(){this.currentPage>1&&(this.currentPage--,this.loadClientes())}nextPage(){this.currentPage<this.totalPages&&(this.currentPage++,this.loadClientes())}};s.\u0275fac=function(t){return new(t||s)(T(U))},s.\u0275cmp=w({type:s,selectors:[["app-cliente-search-modal"]],decls:18,vars:7,consts:[["slot","end"],[3,"click"],[3,"ngModelChange","ionInput","ngModel","debounce"],[3,"button","click",4,"ngFor","ngForOf"],[2,"display","flex","justify-content","center","align-items","center","margin-top","20px","margin-bottom","20px"],[3,"click","disabled"],["interface","popover",3,"ngModelChange","ionChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[3,"click","button"],[3,"value"]],template:function(t,e){t&1&&(o(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),c(3,"Buscar Cliente"),a(),o(4,"ion-buttons",0)(5,"ion-button",1),p("click",function(){return e.cancelar()}),c(6,"Cerrar"),a()()()(),o(7,"ion-content")(8,"ion-searchbar",2),x("ngModelChange",function(u){return I(e.searchTerm,u)||(e.searchTerm=u),u}),p("ionInput",function(){return e.onSearchInput()}),a(),o(9,"ion-list"),P(10,le,8,4,"ion-item",3),a(),o(11,"div",4)(12,"ion-button",5),p("click",function(){return e.changePage("prev")}),c(13,"\u2190"),a(),o(14,"ion-select",6),x("ngModelChange",function(u){return I(e.currentPage,u)||(e.currentPage=u),u}),p("ionChange",function(){return e.loadClientes()}),P(15,ce,2,2,"ion-select-option",7),a(),o(16,"ion-button",5),p("click",function(){return e.changePage("next")}),c(17,"\u2192"),a()()()),t&2&&(l(8),S("ngModel",e.searchTerm),m("debounce",1e3),l(2),m("ngForOf",e.clientes),l(2),m("disabled",e.currentPage===1),l(2),S("ngModel",e.currentPage),l(),m("ngForOf",e.pageOptions),l(),m("disabled",e.currentPage===e.totalPages))},dependencies:[q,L,D,j,O,W,z,V,$,B,A,N,F,J,k,E],styles:['@charset "UTF-8";ion-select[_ngcontent-%COMP%]{max-width:120px;min-width:80px;width:auto;text-align:center}']});let d=s;return d})();function se(d,s){if(d&1){let r=M();o(0,"ion-item")(1,"ion-label"),c(2),y(3,"br"),c(4),y(5,"br"),c(6),y(7,"br"),c(8),a(),o(9,"ion-button",10),p("click",function(){g(r);let t=f();return h(t.eliminarCliente())}),c(10,"Eliminar"),a()()}if(d&2){let r=f();l(2),C(" ",r.cliente.nombre,""),l(2),C(" NIF: ",r.cliente.nif,""),l(2),C(" Correo : ",r.cliente.email,""),l(2),C(" Ciudad : ",r.cliente.ciudad," ")}}function de(d,s){if(d&1){let r=M();o(0,"ion-item")(1,"ion-label"),c(2),y(3,"br"),o(4,"ion-input",11),x("ngModelChange",function(t){let e=g(r).$implicit;return I(e.precioNeto,t)||(e.precioNeto=t),h(t)}),p("ionBlur",function(){let t=g(r).index,e=f();return h(e.actualizarSubtotal(t))})("ionFocus",function(){let t=g(r).index,e=f();return h(e.guardarValorAnterior(t))}),a(),o(5,"ion-input",12),x("ngModelChange",function(t){let e=g(r).$implicit;return I(e.cantidad,t)||(e.cantidad=t),h(t)}),p("ionBlur",function(){let t=g(r).index,e=f();return h(e.actualizarSubtotal(t))})("ionFocus",function(){let t=g(r).index,e=f();return h(e.guardarValorAnterior(t))}),a(),c(6),y(7,"br"),c(8),a(),o(9,"ion-button",10),p("click",function(){let t=g(r).index,e=f();return h(e.eliminarProducto(t))}),c(10,"Eliminar"),a()()}if(d&2){let r=s.$implicit;l(2),C(" ",r.nombre,""),l(2),S("ngModel",r.precioNeto),l(),S("ngModel",r.cantidad),l(),C(" IVA: ",r.iva,"%"),l(2),C(" Subtotal: ",r.subtotal," \u20AC ")}}function pe(d,s){if(d&1){let r=M();o(0,"ion-button",13),p("click",function(){g(r);let t=f();return h(t.crearPedido())}),c(1,"Crear Pedido"),a()}}var Ve=(()=>{let s=class s{constructor(i,t){this.modalController=i,this.router=t,this.productosSeleccionados=[],this.valorAnteriorPrecioNeto=[],this.valorAnteriorCantidad=[]}ngOnInit(){}abrirBusquedaProducto(){return H(this,null,function*(){let i=yield this.modalController.create({component:ne});return i.onDidDismiss().then(t=>{t.data&&this.agregarProductoAlPedido(t.data.producto)}),yield i.present()})}agregarProductoAlPedido(i){this.productosSeleccionados.find(e=>e.nombre===i.nombre)||this.productosSeleccionados.push({id:i.id,nombre:i.nombre,precioNeto:i.precioNeto,iva:i.iva,cantidad:1,subtotal:this.calcularSubtotal(i.precioNeto,1,i.iva)})}guardarValorAnterior(i){let t=this.productosSeleccionados[i],e=parseFloat(t.cantidad),n=parseFloat(t.precioNeto);this.valorAnteriorCantidad[i]=isNaN(e)?1:e,this.valorAnteriorPrecioNeto[i]=isNaN(n)?0:n}actualizarSubtotal(i){let t=this.productosSeleccionados[i],e=parseFloat(t.precioNeto),n=parseFloat(t.cantidad);(isNaN(e)||e<=0)&&(t.precioNeto=this.valorAnteriorPrecioNeto[i]),(isNaN(n)||n<=0)&&(t.cantidad=this.valorAnteriorCantidad[i]),t.subtotal=this.calcularSubtotal(t.precioNeto,t.cantidad,t.iva)}calcularSubtotal(i,t,e){return i*t+i*t*e/100}eliminarProducto(i){this.productosSeleccionados.splice(i,1)}calcularTotal(){return this.productosSeleccionados.reduce((i,t)=>i+t.subtotal,0)}abrirBusquedaCliente(){return H(this,null,function*(){let i=yield this.modalController.create({component:oe});return i.onDidDismiss().then(t=>{t.data&&this.agregarClienteAlPedido(t.data.cliente)}),yield i.present()})}agregarClienteAlPedido(i){this.cliente==i||(this.cliente=i),console.log(i)}eliminarCliente(){this.cliente=null}crearPedido(){if(!this.cliente||this.productosSeleccionados.length===0){alert("Debes seleccionar un cliente y al menos un producto para crear el pedido.");return}let i=localStorage.getItem("accessToken");if(!i){console.log("No se encontr\xF3 el token de acceso");return}fetch(v.apiUrl+"/pedido",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({cliente:this.cliente,total:this.calcularTotal()})}).then(t=>t.text()).then(t=>{let e=Number(t.trim());isNaN(e)?alert("Error en el registro: "+t):(alert("Pedido creado"),this.crearDetalles(i,e,this.productosSeleccionados),this.router.navigate(["/pedidos"]))}).catch(t=>{console.error("Error en la solicitud:",t),alert("Error en la solicitud")})}crearDetalles(i,t,e){let n=v.apiUrl+`/pedidos/${t}/detalles`,u=e.map(_=>({pedido:{id:t},producto:{id:_.id,iva:_.iva},precioNeto:_.precioNeto,cantidad:_.cantidad}));fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(u)}).then(_=>_.text()).then(_=>{_.trim()==="Detalles creados"?console.log("Detalles creados"):alert("Error en el registro: "+_)}).catch(_=>{console.error("Error en la solicitud:",_),alert("Error en la solicitud")})}};s.\u0275fac=function(t){return new(t||s)(T(U),T(G))},s.\u0275cmp=w({type:s,selectors:[["app-pedido-add"]],decls:22,vars:6,consts:[[3,"translucent"],["slot","start"],["defaultHref","/pedidos"],[1,"centrar"],[4,"ngIf"],["expand","full",1,"boton-a\xF1adir-cliente",3,"click"],[4,"ngFor","ngForOf"],["expand","full",1,"boton-a\xF1adir-producto",3,"click"],["slot","end"],["class","boton-crear","expand","full","color","success",3,"click",4,"ngIf"],["color","danger",3,"click"],["label","Precio Neto:","type","number","min","1","pattern","^[0-9]*[.,]?[0-9]*$",2,"max-width","200px",3,"ngModelChange","ionBlur","ionFocus","ngModel"],["label","Cantidad:","type","number","min","1","pattern","^[0-9]*[.,]?[0-9]*$",2,"max-width","200px",3,"ngModelChange","ionBlur","ionFocus","ngModel"],["expand","full","color","success",1,"boton-crear",3,"click"]],template:function(t,e){t&1&&(o(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-buttons",1),y(3,"ion-back-button",2),a(),o(4,"ion-title"),c(5,"Crear pedido"),a()()(),o(6,"ion-content")(7,"div",3),y(8,"br"),P(9,se,11,4,"ion-item",4),o(10,"ion-button",5),p("click",function(){return e.abrirBusquedaCliente()}),c(11),a(),o(12,"ion-list"),P(13,de,11,5,"ion-item",6),a(),o(14,"ion-button",7),p("click",function(){return e.abrirBusquedaProducto()}),c(15,"A\xF1adir Producto"),a(),o(16,"ion-item")(17,"h4",8)(18,"b"),c(19),a()()()()(),o(20,"ion-footer",3),P(21,pe,2,0,"ion-button",9),a()),t&2&&(m("translucent",!0),l(9),m("ngIf",e.cliente),l(2),b(e.cliente?"Cambiar Cliente":"A\xF1adir Cliente"),l(2),m("ngForOf",e.productosSeleccionados),l(6),C("Total: ",e.calcularTotal()," \u20AC"),l(2),m("ngIf",e.cliente&&e.productosSeleccionados.length>0))},dependencies:[B,W,$,z,k,E,R,A,N,K,F,O,D,j,Y,L,V,Q,X],styles:['@charset "UTF-8";.boton-a\\f1 adir-cliente[_ngcontent-%COMP%], .boton-a\\f1 adir-producto[_ngcontent-%COMP%], .boton-crear[_ngcontent-%COMP%]{padding:20px}']});let d=s;return d})();export{Ve as PedidoAddPage};
