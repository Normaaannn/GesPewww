import"./chunk-OOJV66GW.js";import"./chunk-DIOT67RP.js";import"./chunk-T5ABTVR2.js";import"./chunk-EIUGSWZD.js";import"./chunk-TW6IKH4B.js";import"./chunk-ZWHDOK3R.js";import"./chunk-4PGTP63H.js";import"./chunk-BDVXA75T.js";import"./chunk-HC6MZPB3.js";import"./chunk-I3LG7LOT.js";import"./chunk-FERD25SW.js";import"./chunk-7EU7YSXT.js";import"./chunk-LEIMCQKJ.js";import"./chunk-KKMBB4JE.js";import"./chunk-BZ2JL7UE.js";import"./chunk-5OMUW5VI.js";import"./chunk-OBXDPQ3V.js";import"./chunk-GZWEEWZ4.js";import"./chunk-MCRJI3T3.js";import"./chunk-MAJNWM2K.js";import"./chunk-5LUBTVRJ.js";import{a as M}from"./chunk-GGPG3CNO.js";import{Ab as j,B as u,Ba as E,Bb as z,D as r,E as a,Ea as A,F as S,Hb as R,J as y,Ja as Z,K as m,Ka as ee,Kb as L,L as f,La as F,Lb as $,Mb as U,Ob as ne,S as c,Sb as oe,T as C,Tb as G,U as b,V as K,X as x,Y as I,Z as v,aa as J,ba as q,eb as te,ga as N,ha as Q,j as _,k as g,ka as X,la as k,lb as O,mb as V,r as l,s as T,tb as B,u as w,ua as Y,xb as ie,y as P,yb as D,zb as W}from"./chunk-37LTOCVS.js";import"./chunk-L2GIMNSN.js";import"./chunk-7KGURMOZ.js";import"./chunk-YZINE4VV.js";import"./chunk-OITPVWB3.js";import"./chunk-YXCBSPVC.js";import"./chunk-HII7ZFLR.js";import"./chunk-7JVEMCNU.js";import"./chunk-Z65EUC5N.js";import"./chunk-4U6PRYVA.js";import"./chunk-ETCIABSX.js";import"./chunk-JWIEPCRG.js";import"./chunk-QPVVTFFW.js";import"./chunk-J6ICYO4L.js";import"./chunk-LF5XB4YN.js";import{f as H}from"./chunk-RW4GY4BD.js";function pe(d,s){if(d&1){let o=y();r(0,"ion-item",8),m("click",function(){let e=_(o).$implicit,t=f();return g(t.seleccionarProducto(e))}),r(1,"ion-label")(2,"h2"),c(3),a(),r(4,"p"),c(5),a(),r(6,"p"),c(7),a()()()}if(d&2){let o=s.$implicit;u("button",!0),l(3),C(o.nombre),l(2),C(o.descripcion),l(2),b("Precio neto : ",o.precioNeto," \u20AC")}}function me(d,s){if(d&1&&(r(0,"ion-select-option",9),c(1),a()),d&2){let o=s.$implicit;u("value",o),l(),C(o)}}var se=(()=>{let s=class s{constructor(i){this.modalController=i,this.productos=[],this.searchTerm="",this.currentPage=1,this.totalPages=1,this.pageSize=20,this.pageOptions=[]}ngOnInit(){this.loadProductos()}loadProductos(i=1){let e=localStorage.getItem("accessToken");if(!e){console.log("No se encontr\xF3 el token de acceso");return}let t="";i===1?t=M.apiUrl+`/producto/activos/page/${this.currentPage}`:i===2&&(t=M.apiUrl+`/producto/buscar/activos/${this.searchTerm}/page/${this.currentPage}`),fetch(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}).then(n=>{if(!n.ok)throw new Error("Error en la solicitud");return n.json()}).then(n=>{console.log("Respuesta completa:",n),typeof n=="string"&&(n=JSON.parse(n),console.log("Convertido a JSON:",n)),Array.isArray(n)?this.productos=n:n&&n.content?(this.productos=n.content,this.totalPages=n.totalPages||1,this.pageOptions=Array.from({length:this.totalPages},(p,h)=>h+1)):console.warn("Formato de datos inesperado:",n)})}onSearchInput(){this.searchTerm.trim()===""?this.loadProductos(1):this.loadProductos(2)}seleccionarProducto(i){this.modalController.dismiss({producto:i})}cancelar(){this.modalController.dismiss()}changePage(i){i==="prev"&&this.currentPage>1?this.currentPage--:i==="next"&&this.currentPage<this.totalPages&&this.currentPage++,this.loadProductos()}previousPage(){this.currentPage>1&&(this.currentPage--,this.loadProductos())}nextPage(){this.currentPage<this.totalPages&&(this.currentPage++,this.loadProductos())}};s.\u0275fac=function(e){return new(e||s)(T(U))},s.\u0275cmp=w({type:s,selectors:[["app-producto-search-modal"]],decls:18,vars:7,consts:[["slot","end"],[3,"click"],[3,"ngModelChange","ionInput","ngModel","debounce"],[3,"button","click",4,"ngFor","ngForOf"],[2,"display","flex","justify-content","center","align-items","center","margin-top","20px","margin-bottom","20px"],[3,"click","disabled"],["interface","popover",3,"ngModelChange","ionChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[3,"click","button"],[3,"value"]],template:function(e,t){e&1&&(r(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),c(3,"Buscar Producto"),a(),r(4,"ion-buttons",0)(5,"ion-button",1),m("click",function(){return t.cancelar()}),c(6,"Cerrar"),a()()()(),r(7,"ion-content")(8,"ion-searchbar",2),v("ngModelChange",function(p){return I(t.searchTerm,p)||(t.searchTerm=p),p}),m("ionInput",function(){return t.onSearchInput()}),a(),r(9,"ion-list"),P(10,pe,8,4,"ion-item",3),a(),r(11,"div",4)(12,"ion-button",5),m("click",function(){return t.changePage("prev")}),c(13,"\u2190"),a(),r(14,"ion-select",6),v("ngModelChange",function(p){return I(t.currentPage,p)||(t.currentPage=p),p}),m("ionChange",function(){return t.loadProductos()}),P(15,me,2,2,"ion-select-option",7),a(),r(16,"ion-button",5),m("click",function(){return t.changePage("next")}),c(17,"\u2192"),a()()()),e&2&&(l(8),x("ngModel",t.searchTerm),u("debounce",1e3),l(2),u("ngForOf",t.productos),l(2),u("disabled",t.currentPage===1),l(2),x("ngModel",t.currentPage),l(),u("ngForOf",t.pageOptions),l(),u("disabled",t.currentPage===t.totalPages))},dependencies:[G,z,W,j,O,D,$,V,L,B,F,E,A,R,k,N],styles:['@charset "UTF-8";ion-select[_ngcontent-%COMP%]{max-width:120px;min-width:80px;width:auto;text-align:center}']});let d=s;return d})();function ue(d,s){if(d&1){let o=y();r(0,"ion-item",8),m("click",function(){let e=_(o).$implicit,t=f();return g(t.seleccionarCliente(e))}),r(1,"ion-label")(2,"h2"),c(3),a(),r(4,"p"),c(5),a(),r(6,"p"),c(7),a()()()}if(d&2){let o=s.$implicit;u("button",!0),l(3),C(o.nombre),l(2),C(o.nif),l(2),b("Correo : ",o.email,"")}}function _e(d,s){if(d&1&&(r(0,"ion-select-option",9),c(1),a()),d&2){let o=s.$implicit;u("value",o),l(),C(o)}}var de=(()=>{let s=class s{constructor(i){this.modalController=i,this.clientes=[],this.searchTerm="",this.currentPage=1,this.totalPages=1,this.pageSize=20,this.pageOptions=[]}ngOnInit(){this.loadClientes()}loadClientes(i=1){let e=localStorage.getItem("accessToken");if(!e){console.log("No se encontr\xF3 el token de acceso");return}let t="";i===1?t=M.apiUrl+`/cliente/activos/page/${this.currentPage}`:i===2&&(t=M.apiUrl+`/cliente/buscar/activos/${this.searchTerm}/page/${this.currentPage}`),fetch(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}).then(n=>{if(!n.ok)throw new Error("Error en la solicitud");return n.json()}).then(n=>{console.log("Respuesta completa:",n),typeof n=="string"&&(n=JSON.parse(n),console.log("Convertido a JSON:",n)),Array.isArray(n)?this.clientes=n:n&&n.content?(this.clientes=n.content,this.totalPages=n.totalPages||1,this.pageOptions=Array.from({length:this.totalPages},(p,h)=>h+1)):console.warn("Formato de datos inesperado:",n)})}onSearchInput(){this.searchTerm.trim()===""?this.loadClientes(1):this.loadClientes(2)}seleccionarCliente(i){this.modalController.dismiss({cliente:i})}cancelar(){this.modalController.dismiss()}changePage(i){i==="prev"&&this.currentPage>1?this.currentPage--:i==="next"&&this.currentPage<this.totalPages&&this.currentPage++,this.loadClientes()}previousPage(){this.currentPage>1&&(this.currentPage--,this.loadClientes())}nextPage(){this.currentPage<this.totalPages&&(this.currentPage++,this.loadClientes())}};s.\u0275fac=function(e){return new(e||s)(T(U))},s.\u0275cmp=w({type:s,selectors:[["app-cliente-search-modal"]],decls:18,vars:7,consts:[["slot","end"],[3,"click"],[3,"ngModelChange","ionInput","ngModel","debounce"],[3,"button","click",4,"ngFor","ngForOf"],[2,"display","flex","justify-content","center","align-items","center","margin-top","20px","margin-bottom","20px"],[3,"click","disabled"],["interface","popover",3,"ngModelChange","ionChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[3,"click","button"],[3,"value"]],template:function(e,t){e&1&&(r(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),c(3,"Buscar Cliente"),a(),r(4,"ion-buttons",0)(5,"ion-button",1),m("click",function(){return t.cancelar()}),c(6,"Cerrar"),a()()()(),r(7,"ion-content")(8,"ion-searchbar",2),v("ngModelChange",function(p){return I(t.searchTerm,p)||(t.searchTerm=p),p}),m("ionInput",function(){return t.onSearchInput()}),a(),r(9,"ion-list"),P(10,ue,8,4,"ion-item",3),a(),r(11,"div",4)(12,"ion-button",5),m("click",function(){return t.changePage("prev")}),c(13,"\u2190"),a(),r(14,"ion-select",6),v("ngModelChange",function(p){return I(t.currentPage,p)||(t.currentPage=p),p}),m("ionChange",function(){return t.loadClientes()}),P(15,_e,2,2,"ion-select-option",7),a(),r(16,"ion-button",5),m("click",function(){return t.changePage("next")}),c(17,"\u2192"),a()()()),e&2&&(l(8),x("ngModel",t.searchTerm),u("debounce",1e3),l(2),u("ngForOf",t.clientes),l(2),u("disabled",t.currentPage===1),l(2),x("ngModel",t.currentPage),l(),u("ngForOf",t.pageOptions),l(),u("disabled",t.currentPage===t.totalPages))},dependencies:[G,z,W,j,O,D,$,V,L,B,F,E,A,R,k,N],styles:['@charset "UTF-8";ion-select[_ngcontent-%COMP%]{max-width:120px;min-width:80px;width:auto;text-align:center}']});let d=s;return d})();function ge(d,s){if(d&1){let o=y();r(0,"ion-item")(1,"ion-label")(2,"b",10),c(3),a(),S(4,"br"),c(5),S(6,"br"),c(7),S(8,"br"),c(9),a(),r(10,"ion-button",11),m("click",function(){_(o);let e=f();return g(e.eliminarCliente())}),c(11,"Eliminar"),a()()}if(d&2){let o=f();l(3),C(o.cliente.nombre),l(2),b(" NIF: ",o.cliente.nif,""),l(2),b(" Correo : ",o.cliente.email,""),l(2),b(" Ciudad : ",o.cliente.ciudad," ")}}function he(d,s){if(d&1){let o=y();r(0,"ion-item")(1,"ion-label")(2,"b",10),c(3),a(),S(4,"br"),c(5),S(6,"br"),r(7,"ion-input",12),v("ngModelChange",function(e){let t=_(o).$implicit;return I(t.precioNeto,e)||(t.precioNeto=e),g(e)}),m("ngModelChange",function(){let e=_(o),t=e.$implicit,n=e.index,p=f();return g(p.onChange(t.precioNeto,n))})("ionBlur",function(){let e=_(o).index,t=f();return g(t.actualizarSubtotal(e))})("ionFocus",function(){let e=_(o).index,t=f();return g(t.guardarValorAnterior(e))}),a(),r(8,"ion-input",13),v("ngModelChange",function(e){let t=_(o).$implicit;return I(t.cantidad,e)||(t.cantidad=e),g(e)}),m("ngModelChange",function(){let e=_(o),t=e.$implicit,n=e.index,p=f();return g(p.onChange(t.cantidad,n))})("ionBlur",function(){let e=_(o).index,t=f();return g(t.actualizarSubtotal(e))})("ionFocus",function(){let e=_(o).index,t=f();return g(t.guardarValorAnterior(e))}),a(),c(9),J(10,"number"),S(11,"br"),c(12),J(13,"number"),S(14,"br")(15,"br"),r(16,"b",14),c(17),J(18,"number"),a()(),r(19,"ion-button",11),m("click",function(){let e=_(o).index,t=f();return g(t.eliminarProducto(e))}),c(20,"Eliminar"),a()()}if(d&2){let o=s.$implicit;l(3),C(o.nombre),l(2),b(" Descripci\xF3n: ",o.descripcion,""),l(2),x("ngModel",o.precioNeto),l(),x("ngModel",o.cantidad),l(),b(" Total Neto: \xA0\xA0 ",q(10,8,o.subtotal-o.ivaTotal,"1.2-2")," \u20AC"),l(3),K(" IVA (",o.iva,"%): \xA0\xA0 ",q(13,11,o.ivaTotal,"1.2-2")," \u20AC"),l(5),b("Subtotal: ",q(18,14,o.subtotal,"1.2-2")," \u20AC")}}function fe(d,s){if(d&1){let o=y();r(0,"ion-button",15),m("click",function(){_(o);let e=f();return g(e.crearPedido())}),c(1,"Crear Pedido"),a()}}var Le=(()=>{let s=class s{constructor(i,e,t){this.modalController=i,this.router=e,this.toastController=t,this.productosSeleccionados=[],this.valorAnteriorPrecioNeto=[],this.valorAnteriorCantidad=[]}ngOnInit(){}abrirBusquedaProducto(){return H(this,null,function*(){let i=yield this.modalController.create({component:se});return i.onDidDismiss().then(e=>{e.data&&this.agregarProductoAlPedido(e.data.producto)}),yield i.present()})}agregarProductoAlPedido(i){if(this.productosSeleccionados.find(t=>t.nombre===i.nombre))this.presentToast("El producto ya est\xE1 en el pedido");else{let n=this.calcularSubtotal(i.precioNeto,1,i.iva),p=this.calcularIva(n,i.precioNeto,1);this.productosSeleccionados.push({id:i.id,nombre:i.nombre,descripcion:i.descripcion,precioNeto:i.precioNeto,iva:i.iva,cantidad:1,subtotal:n,ivaTotal:p})}}onChange(i,e){i===""||i===null||i===0||this.tieneDecimales(i,2)||this.actualizarSubtotal(e)}guardarValorAnterior(i){let e=this.productosSeleccionados[i],t=Number(e.cantidad),n=Number(e.precioNeto);this.valorAnteriorCantidad[i]=isNaN(t)?1:t,this.valorAnteriorPrecioNeto[i]=isNaN(n)?0:n}actualizarSubtotal(i){let e=this.productosSeleccionados[i],t=Number(e.precioNeto),n=Number(e.cantidad);(isNaN(t)||t<=0||t>9999999999)&&(e.precioNeto=this.valorAnteriorPrecioNeto[i]),(isNaN(n)||n<=0||n>9999999999)&&(e.cantidad=this.valorAnteriorCantidad[i]),this.tieneDecimales(e.precioNeto,2)&&(e.precioNeto=this.recortarADecimales(e.precioNeto,2)),this.tieneDecimales(e.cantidad,2)&&(e.cantidad=this.recortarADecimales(e.cantidad,0)),e.subtotal=this.calcularSubtotal(e.precioNeto,e.cantidad,e.iva),e.ivaTotal=this.calcularIva(e.subtotal,e.precioNeto,e.cantidad)}calcularSubtotal(i,e,t){let n=i*e+i*e*t/100;return Math.round(n*100)/100}calcularIva(i,e,t){let n=i-e*t;return Math.round(n*100)/100}eliminarProducto(i){this.productosSeleccionados.splice(i,1)}calcularTotal(){let i=this.productosSeleccionados.reduce((e,t)=>e+t.subtotal,0);return Math.round(i*100)/100}abrirBusquedaCliente(){return H(this,null,function*(){let i=yield this.modalController.create({component:de});return i.onDidDismiss().then(e=>{e.data&&this.agregarClienteAlPedido(e.data.cliente)}),yield i.present()})}agregarClienteAlPedido(i){this.cliente==i||(this.cliente=i),console.log(i)}eliminarCliente(){this.cliente=null}crearPedido(){if(!this.cliente||this.productosSeleccionados.length===0){alert("Debes seleccionar un cliente y al menos un producto para crear el pedido.");return}let i=localStorage.getItem("accessToken");if(!i){console.log("No se encontr\xF3 el token de acceso");return}fetch(M.apiUrl+"/pedido",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({cliente:this.cliente,total:this.calcularTotal()})}).then(e=>e.text()).then(e=>{let t=Number(e.trim());isNaN(t)?alert("Error en el registro: "+e):(this.crearDetalles(i,t,this.productosSeleccionados),this.presentToast("Pedido creado con \xE9xito"),this.router.navigate(["/pedidos"]))}).catch(e=>{console.error("Error en la solicitud:",e),alert("Error en la solicitud")})}crearDetalles(i,e,t){let n=M.apiUrl+`/pedidos/${e}/detalles`,p=t.map(h=>({pedido:{id:e},producto:{id:h.id,iva:h.iva},precioNeto:h.precioNeto,cantidad:h.cantidad}));fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(p)}).then(h=>h.text()).then(h=>{h.trim()==="Detalles creados"?console.log("Detalles creados"):alert("Error en el registro: "+h)}).catch(h=>{console.error("Error en la solicitud:",h),alert("Error en la solicitud")})}tieneDecimales(i,e){let n=String(i).replace(",",".").split(".");return n.length<2?!1:n[1].length>e}recortarADecimales(i,e){let t=Number(i.toString().replace(",",".")),n=Math.pow(10,e);return Math.trunc(t*n)/n}presentToast(i){return H(this,null,function*(){yield(yield this.toastController.create({message:i,duration:2e3,position:"top",cssClass:"toast"})).present()})}};s.\u0275fac=function(e){return new(e||s)(T(U),T(Y),T(ne))},s.\u0275cmp=w({type:s,selectors:[["app-pedido-add"]],decls:23,vars:9,consts:[[3,"translucent"],["slot","start"],["defaultHref","/pedidos"],[1,"centrar"],[4,"ngIf"],["expand","block",1,"boton-a\xF1adir-cliente",3,"click"],[4,"ngFor","ngForOf"],["expand","block",1,"boton-a\xF1adir-producto",3,"click"],["slot","end"],["class","boton-crear","expand","block","color","success",3,"click",4,"ngIf"],[2,"display","inline-block","margin-bottom","0.5em"],["color","danger",3,"click"],["label","Precio Neto:","type","number","min","1","pattern","^[0-9]*[.,]?[0-9]*$","maxlength","10",2,"max-width","200px",3,"ngModelChange","ionBlur","ionFocus","ngModel"],["label","Cantidad:","type","number","min","1","pattern","^[0-9]*[.,]?[0-9]*$","maxlength","10",2,"max-width","200px",3,"ngModelChange","ionBlur","ionFocus","ngModel"],[2,"font-size","17px"],["expand","block","color","success",1,"boton-crear",3,"click"]],template:function(e,t){e&1&&(r(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-buttons",1),S(3,"ion-back-button",2),a(),r(4,"ion-title"),c(5,"Crear pedido"),a()()(),r(6,"ion-content")(7,"div",3),S(8,"br"),P(9,ge,12,4,"ion-item",4),r(10,"ion-button",5),m("click",function(){return t.abrirBusquedaCliente()}),c(11),a(),r(12,"ion-list"),P(13,he,21,17,"ion-item",6),a(),r(14,"ion-button",7),m("click",function(){return t.abrirBusquedaProducto()}),c(15,"A\xF1adir Producto"),a(),r(16,"ion-item")(17,"h4",8)(18,"b"),c(19),J(20,"number"),a()()()()(),r(21,"ion-footer",3),P(22,fe,2,0,"ion-button",9),a()),e&2&&(u("translucent",!0),l(9),u("ngIf",t.cliente),l(2),C(t.cliente?"Cambiar Cliente":"A\xF1adir Cliente"),l(2),u("ngForOf",t.productosSeleccionados),l(6),b("Total: ",q(20,6,t.calcularTotal(),"1.2-2")," \u20AC"),l(3),u("ngIf",t.cliente&&t.productosSeleccionados.length>0))},dependencies:[B,D,L,$,k,N,Q,X,F,E,Z,ee,A,O,W,j,oe,z,V,te,ie],styles:['@charset "UTF-8";.boton-a\\f1 adir-cliente[_ngcontent-%COMP%], .boton-a\\f1 adir-producto[_ngcontent-%COMP%], .boton-crear[_ngcontent-%COMP%]{padding:20px}']});let d=s;return d})();export{Le as PedidoAddPage};
