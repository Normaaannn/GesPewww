import"./chunk-3RMIGUHL.js";import"./chunk-CRMNYVNJ.js";import"./chunk-DWTMSAJF.js";import"./chunk-EIUGSWZD.js";import"./chunk-TW6IKH4B.js";import"./chunk-ZWHDOK3R.js";import"./chunk-4PGTP63H.js";import"./chunk-BDVXA75T.js";import"./chunk-HC6MZPB3.js";import"./chunk-I3LG7LOT.js";import"./chunk-FERD25SW.js";import"./chunk-7EU7YSXT.js";import"./chunk-LEIMCQKJ.js";import"./chunk-KKMBB4JE.js";import"./chunk-BZ2JL7UE.js";import"./chunk-5OMUW5VI.js";import"./chunk-OBXDPQ3V.js";import"./chunk-GZWEEWZ4.js";import"./chunk-MCRJI3T3.js";import"./chunk-MAJNWM2K.js";import"./chunk-5LUBTVRJ.js";import{a as M}from"./chunk-GGPG3CNO.js";import{B as p,Ba as A,Cb as J,D as r,E as a,F as y,Fb as $,Ga as K,Gb as z,Ha as F,Hb as U,J as v,K as m,L as f,Nb as Y,Ob as q,S as c,T as b,U as C,W as S,X as x,Y as I,ab as Q,fa as E,ga as R,hb as O,ib as V,j as _,ja as N,k as g,pb as B,r as l,s as T,sa as G,tb as X,u as w,ub as W,vb as D,wb as j,xb as L,y as P,ya as k}from"./chunk-GOUZPZED.js";import"./chunk-L2GIMNSN.js";import"./chunk-7KGURMOZ.js";import"./chunk-YZINE4VV.js";import"./chunk-OITPVWB3.js";import"./chunk-YXCBSPVC.js";import"./chunk-HII7ZFLR.js";import"./chunk-7JVEMCNU.js";import"./chunk-Z65EUC5N.js";import"./chunk-4U6PRYVA.js";import"./chunk-ETCIABSX.js";import"./chunk-JWIEPCRG.js";import"./chunk-QPVVTFFW.js";import"./chunk-J6ICYO4L.js";import"./chunk-LF5XB4YN.js";import{f as H}from"./chunk-RW4GY4BD.js";function re(d,s){if(d&1){let o=v();r(0,"ion-item",8),m("click",function(){let e=_(o).$implicit,t=f();return g(t.seleccionarProducto(e))}),r(1,"ion-label")(2,"h2"),c(3),a(),r(4,"p"),c(5),a(),r(6,"p"),c(7),a()()()}if(d&2){let o=s.$implicit;p("button",!0),l(3),b(o.nombre),l(2),b(o.descripcion),l(2),C("Precio neto : ",o.precioNeto," \u20AC")}}function ae(d,s){if(d&1&&(r(0,"ion-select-option",9),c(1),a()),d&2){let o=s.$implicit;p("value",o),l(),b(o)}}var ne=(()=>{let s=class s{constructor(i){this.modalController=i,this.productos=[],this.searchTerm="",this.currentPage=1,this.totalPages=1,this.pageSize=20,this.pageOptions=[]}ngOnInit(){this.loadProductos()}loadProductos(i=1){let e=localStorage.getItem("accessToken");if(!e){console.log("No se encontr\xF3 el token de acceso");return}let t="";i===1?t=M.apiUrl+`/producto/activos/page/${this.currentPage}`:i===2&&(t=M.apiUrl+`/producto/buscar/activos/${this.searchTerm}/page/${this.currentPage}`),fetch(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}).then(n=>{if(!n.ok)throw new Error("Error en la solicitud");return n.json()}).then(n=>{console.log("Respuesta completa:",n),typeof n=="string"&&(n=JSON.parse(n),console.log("Convertido a JSON:",n)),Array.isArray(n)?this.productos=n:n&&n.content?(this.productos=n.content,this.totalPages=n.totalPages||1,this.pageOptions=Array.from({length:this.totalPages},(u,h)=>h+1)):console.warn("Formato de datos inesperado:",n)})}onSearchInput(){this.searchTerm.trim()===""?this.loadProductos(1):this.loadProductos(2)}seleccionarProducto(i){this.modalController.dismiss({producto:i})}cancelar(){this.modalController.dismiss()}changePage(i){i==="prev"&&this.currentPage>1?this.currentPage--:i==="next"&&this.currentPage<this.totalPages&&this.currentPage++,this.loadProductos()}previousPage(){this.currentPage>1&&(this.currentPage--,this.loadProductos())}nextPage(){this.currentPage<this.totalPages&&(this.currentPage++,this.loadProductos())}};s.\u0275fac=function(e){return new(e||s)(T(U))},s.\u0275cmp=w({type:s,selectors:[["app-producto-search-modal"]],decls:18,vars:7,consts:[["slot","end"],[3,"click"],[3,"ngModelChange","ionInput","ngModel","debounce"],[3,"button","click",4,"ngFor","ngForOf"],[2,"display","flex","justify-content","center","align-items","center","margin-top","20px","margin-bottom","20px"],[3,"click","disabled"],["interface","popover",3,"ngModelChange","ionChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[3,"click","button"],[3,"value"]],template:function(e,t){e&1&&(r(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),c(3,"Buscar Producto"),a(),r(4,"ion-buttons",0)(5,"ion-button",1),m("click",function(){return t.cancelar()}),c(6,"Cerrar"),a()()()(),r(7,"ion-content")(8,"ion-searchbar",2),I("ngModelChange",function(u){return x(t.searchTerm,u)||(t.searchTerm=u),u}),m("ionInput",function(){return t.onSearchInput()}),a(),r(9,"ion-list"),P(10,re,8,4,"ion-item",3),a(),r(11,"div",4)(12,"ion-button",5),m("click",function(){return t.changePage("prev")}),c(13,"\u2190"),a(),r(14,"ion-select",6),I("ngModelChange",function(u){return x(t.currentPage,u)||(t.currentPage=u),u}),m("ionChange",function(){return t.loadProductos()}),P(15,ae,2,2,"ion-select-option",7),a(),r(16,"ion-button",5),m("click",function(){return t.changePage("next")}),c(17,"\u2192"),a()()()),e&2&&(l(8),S("ngModel",t.searchTerm),p("debounce",1e3),l(2),p("ngForOf",t.productos),l(2),p("disabled",t.currentPage===1),l(2),S("ngModel",t.currentPage),l(),p("ngForOf",t.pageOptions),l(),p("disabled",t.currentPage===t.totalPages))},dependencies:[q,L,D,j,O,W,z,V,$,B,F,k,A,J,N,E],styles:['@charset "UTF-8";ion-select[_ngcontent-%COMP%]{max-width:120px;min-width:80px;width:auto;text-align:center}']});let d=s;return d})();function le(d,s){if(d&1){let o=v();r(0,"ion-item",8),m("click",function(){let e=_(o).$implicit,t=f();return g(t.seleccionarCliente(e))}),r(1,"ion-label")(2,"h2"),c(3),a(),r(4,"p"),c(5),a(),r(6,"p"),c(7),a()()()}if(d&2){let o=s.$implicit;p("button",!0),l(3),b(o.nombre),l(2),b(o.nif),l(2),C("Correo : ",o.email,"")}}function ce(d,s){if(d&1&&(r(0,"ion-select-option",9),c(1),a()),d&2){let o=s.$implicit;p("value",o),l(),b(o)}}var oe=(()=>{let s=class s{constructor(i){this.modalController=i,this.clientes=[],this.searchTerm="",this.currentPage=1,this.totalPages=1,this.pageSize=20,this.pageOptions=[]}ngOnInit(){this.loadClientes()}loadClientes(i=1){let e=localStorage.getItem("accessToken");if(!e){console.log("No se encontr\xF3 el token de acceso");return}let t="";i===1?t=M.apiUrl+`/cliente/activos/page/${this.currentPage}`:i===2&&(t=M.apiUrl+`/cliente/buscar/activos/${this.searchTerm}/page/${this.currentPage}`),fetch(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}).then(n=>{if(!n.ok)throw new Error("Error en la solicitud");return n.json()}).then(n=>{console.log("Respuesta completa:",n),typeof n=="string"&&(n=JSON.parse(n),console.log("Convertido a JSON:",n)),Array.isArray(n)?this.clientes=n:n&&n.content?(this.clientes=n.content,this.totalPages=n.totalPages||1,this.pageOptions=Array.from({length:this.totalPages},(u,h)=>h+1)):console.warn("Formato de datos inesperado:",n)})}onSearchInput(){this.searchTerm.trim()===""?this.loadClientes(1):this.loadClientes(2)}seleccionarCliente(i){this.modalController.dismiss({cliente:i})}cancelar(){this.modalController.dismiss()}changePage(i){i==="prev"&&this.currentPage>1?this.currentPage--:i==="next"&&this.currentPage<this.totalPages&&this.currentPage++,this.loadClientes()}previousPage(){this.currentPage>1&&(this.currentPage--,this.loadClientes())}nextPage(){this.currentPage<this.totalPages&&(this.currentPage++,this.loadClientes())}};s.\u0275fac=function(e){return new(e||s)(T(U))},s.\u0275cmp=w({type:s,selectors:[["app-cliente-search-modal"]],decls:18,vars:7,consts:[["slot","end"],[3,"click"],[3,"ngModelChange","ionInput","ngModel","debounce"],[3,"button","click",4,"ngFor","ngForOf"],[2,"display","flex","justify-content","center","align-items","center","margin-top","20px","margin-bottom","20px"],[3,"click","disabled"],["interface","popover",3,"ngModelChange","ionChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],[3,"click","button"],[3,"value"]],template:function(e,t){e&1&&(r(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),c(3,"Buscar Cliente"),a(),r(4,"ion-buttons",0)(5,"ion-button",1),m("click",function(){return t.cancelar()}),c(6,"Cerrar"),a()()()(),r(7,"ion-content")(8,"ion-searchbar",2),I("ngModelChange",function(u){return x(t.searchTerm,u)||(t.searchTerm=u),u}),m("ionInput",function(){return t.onSearchInput()}),a(),r(9,"ion-list"),P(10,le,8,4,"ion-item",3),a(),r(11,"div",4)(12,"ion-button",5),m("click",function(){return t.changePage("prev")}),c(13,"\u2190"),a(),r(14,"ion-select",6),I("ngModelChange",function(u){return x(t.currentPage,u)||(t.currentPage=u),u}),m("ionChange",function(){return t.loadClientes()}),P(15,ce,2,2,"ion-select-option",7),a(),r(16,"ion-button",5),m("click",function(){return t.changePage("next")}),c(17,"\u2192"),a()()()),e&2&&(l(8),S("ngModel",t.searchTerm),p("debounce",1e3),l(2),p("ngForOf",t.clientes),l(2),p("disabled",t.currentPage===1),l(2),S("ngModel",t.currentPage),l(),p("ngForOf",t.pageOptions),l(),p("disabled",t.currentPage===t.totalPages))},dependencies:[q,L,D,j,O,W,z,V,$,B,F,k,A,J,N,E],styles:['@charset "UTF-8";ion-select[_ngcontent-%COMP%]{max-width:120px;min-width:80px;width:auto;text-align:center}']});let d=s;return d})();function se(d,s){if(d&1){let o=v();r(0,"ion-item")(1,"ion-label"),c(2),y(3,"br"),c(4),y(5,"br"),c(6),y(7,"br"),c(8),a(),r(9,"ion-button",10),m("click",function(){_(o);let e=f();return g(e.eliminarCliente())}),c(10,"Eliminar"),a()()}if(d&2){let o=f();l(2),C(" ",o.cliente.nombre,""),l(2),C(" NIF: ",o.cliente.nif,""),l(2),C(" Correo : ",o.cliente.email,""),l(2),C(" Ciudad : ",o.cliente.ciudad," ")}}function de(d,s){if(d&1){let o=v();r(0,"ion-item")(1,"ion-label"),c(2),y(3,"br"),r(4,"ion-input",11),I("ngModelChange",function(e){let t=_(o).$implicit;return x(t.precioNeto,e)||(t.precioNeto=e),g(e)}),m("ngModelChange",function(){let e=_(o),t=e.$implicit,n=e.index,u=f();return g(u.onChange(t.precioNeto,n))})("ionBlur",function(){let e=_(o).index,t=f();return g(t.actualizarSubtotal(e))})("ionFocus",function(){let e=_(o).index,t=f();return g(t.guardarValorAnterior(e))}),a(),r(5,"ion-input",12),I("ngModelChange",function(e){let t=_(o).$implicit;return x(t.cantidad,e)||(t.cantidad=e),g(e)}),m("ngModelChange",function(){let e=_(o),t=e.$implicit,n=e.index,u=f();return g(u.onChange(t.cantidad,n))})("ionBlur",function(){let e=_(o).index,t=f();return g(t.actualizarSubtotal(e))})("ionFocus",function(){let e=_(o).index,t=f();return g(t.guardarValorAnterior(e))}),a(),c(6),y(7,"br"),c(8),a(),r(9,"ion-button",10),m("click",function(){let e=_(o).index,t=f();return g(t.eliminarProducto(e))}),c(10,"Eliminar"),a()()}if(d&2){let o=s.$implicit;l(2),C(" ",o.nombre,""),l(2),S("ngModel",o.precioNeto),l(),S("ngModel",o.cantidad),l(),C(" IVA: ",o.iva,"%"),l(2),C(" Subtotal: ",o.subtotal," \u20AC ")}}function ue(d,s){if(d&1){let o=v();r(0,"ion-button",13),m("click",function(){_(o);let e=f();return g(e.crearPedido())}),c(1,"Crear Pedido"),a()}}var Ve=(()=>{let s=class s{constructor(i,e){this.modalController=i,this.router=e,this.productosSeleccionados=[],this.valorAnteriorPrecioNeto=[],this.valorAnteriorCantidad=[]}ngOnInit(){}abrirBusquedaProducto(){return H(this,null,function*(){let i=yield this.modalController.create({component:ne});return i.onDidDismiss().then(e=>{e.data&&this.agregarProductoAlPedido(e.data.producto)}),yield i.present()})}agregarProductoAlPedido(i){this.productosSeleccionados.find(t=>t.nombre===i.nombre)||this.productosSeleccionados.push({id:i.id,nombre:i.nombre,precioNeto:i.precioNeto,iva:i.iva,cantidad:1,subtotal:this.calcularSubtotal(i.precioNeto,1,i.iva)})}onChange(i,e){i===""||i===null||i===0||this.actualizarSubtotal(e)}guardarValorAnterior(i){let e=this.productosSeleccionados[i],t=Number(e.cantidad),n=Number(e.precioNeto);this.valorAnteriorCantidad[i]=isNaN(t)?1:t,this.valorAnteriorPrecioNeto[i]=isNaN(n)?0:n}actualizarSubtotal(i){let e=this.productosSeleccionados[i],t=Number(e.precioNeto),n=Number(e.cantidad);(isNaN(t)||t<=0)&&(e.precioNeto=this.valorAnteriorPrecioNeto[i]),(isNaN(n)||n<=0)&&(e.cantidad=this.valorAnteriorCantidad[i]),e.subtotal=this.calcularSubtotal(e.precioNeto,e.cantidad,e.iva)}calcularSubtotal(i,e,t){let n=i*e+i*e*t/100;return Math.round(n*100)/100}eliminarProducto(i){this.productosSeleccionados.splice(i,1)}calcularTotal(){let i=this.productosSeleccionados.reduce((e,t)=>e+t.subtotal,0);return Math.round(i*100)/100}abrirBusquedaCliente(){return H(this,null,function*(){let i=yield this.modalController.create({component:oe});return i.onDidDismiss().then(e=>{e.data&&this.agregarClienteAlPedido(e.data.cliente)}),yield i.present()})}agregarClienteAlPedido(i){this.cliente==i||(this.cliente=i),console.log(i)}eliminarCliente(){this.cliente=null}crearPedido(){if(!this.cliente||this.productosSeleccionados.length===0){alert("Debes seleccionar un cliente y al menos un producto para crear el pedido.");return}let i=localStorage.getItem("accessToken");if(!i){console.log("No se encontr\xF3 el token de acceso");return}fetch(M.apiUrl+"/pedido",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({cliente:this.cliente,total:this.calcularTotal()})}).then(e=>e.text()).then(e=>{let t=Number(e.trim());isNaN(t)?alert("Error en el registro: "+e):(alert("Pedido creado"),this.crearDetalles(i,t,this.productosSeleccionados),this.router.navigate(["/pedidos"]))}).catch(e=>{console.error("Error en la solicitud:",e),alert("Error en la solicitud")})}crearDetalles(i,e,t){let n=M.apiUrl+`/pedidos/${e}/detalles`,u=t.map(h=>({pedido:{id:e},producto:{id:h.id,iva:h.iva},precioNeto:h.precioNeto,cantidad:h.cantidad}));fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(u)}).then(h=>h.text()).then(h=>{h.trim()==="Detalles creados"?console.log("Detalles creados"):alert("Error en el registro: "+h)}).catch(h=>{console.error("Error en la solicitud:",h),alert("Error en la solicitud")})}};s.\u0275fac=function(e){return new(e||s)(T(U),T(G))},s.\u0275cmp=w({type:s,selectors:[["app-pedido-add"]],decls:22,vars:6,consts:[[3,"translucent"],["slot","start"],["defaultHref","/pedidos"],[1,"centrar"],[4,"ngIf"],["expand","full",1,"boton-a\xF1adir-cliente",3,"click"],[4,"ngFor","ngForOf"],["expand","full",1,"boton-a\xF1adir-producto",3,"click"],["slot","end"],["class","boton-crear","expand","full","color","success",3,"click",4,"ngIf"],["color","danger",3,"click"],["label","Precio Neto:","type","number","min","1","pattern","^[0-9]*[.,]?[0-9]*$",2,"max-width","200px",3,"ngModelChange","ionBlur","ionFocus","ngModel"],["label","Cantidad:","type","number","min","1","pattern","^[0-9]*[.,]?[0-9]*$",2,"max-width","200px",3,"ngModelChange","ionBlur","ionFocus","ngModel"],["expand","full","color","success",1,"boton-crear",3,"click"]],template:function(e,t){e&1&&(r(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-buttons",1),y(3,"ion-back-button",2),a(),r(4,"ion-title"),c(5,"Crear pedido"),a()()(),r(6,"ion-content")(7,"div",3),y(8,"br"),P(9,se,11,4,"ion-item",4),r(10,"ion-button",5),m("click",function(){return t.abrirBusquedaCliente()}),c(11),a(),r(12,"ion-list"),P(13,de,11,5,"ion-item",6),a(),r(14,"ion-button",7),m("click",function(){return t.abrirBusquedaProducto()}),c(15,"A\xF1adir Producto"),a(),r(16,"ion-item")(17,"h4",8)(18,"b"),c(19),a()()()()(),r(20,"ion-footer",3),P(21,ue,2,0,"ion-button",9),a()),e&2&&(p("translucent",!0),l(9),p("ngIf",t.cliente),l(2),b(t.cliente?"Cambiar Cliente":"A\xF1adir Cliente"),l(2),p("ngForOf",t.productosSeleccionados),l(6),C("Total: ",t.calcularTotal()," \u20AC"),l(2),p("ngIf",t.cliente&&t.productosSeleccionados.length>0))},dependencies:[B,W,$,z,N,E,R,F,k,K,A,O,D,j,Y,L,V,Q,X],styles:['@charset "UTF-8";.boton-a\\f1 adir-cliente[_ngcontent-%COMP%], .boton-a\\f1 adir-producto[_ngcontent-%COMP%], .boton-crear[_ngcontent-%COMP%]{padding:20px}']});let d=s;return d})();export{Ve as PedidoAddPage};
